<!DOCTYPE html>
<html>
	<head>
		<script src="sjcl.js"></script>
		<script>
			function decrypt(base64text, password) {
				return sjcl.decrypt(password, atob(base64text.replace(/\n/g, '')), {}, {})
			}
			function gibberish(base64text) {
				return JSON.parse(atob(encodedMessage.value.replace(/\n/g, '')))
					.ct
					.replace(/(.{80})/g, '$1\n');
			}
			var plaintext;
			window.onload = function() {
				var decode = document.getElementById('decode');
				var password = document.getElementById('password');
				var encodedMessage = document.getElementById('encodedMessage');
				var message = document.getElementById('message');
				var errorMessage = document.getElementById('errorMessage');
				decode.onclick = function() {
					try {
						plaintext = decrypt(encodedMessage.value, password.value);
						message.innerHTML = plaintext
							.replace(/\n/g, '<br>')
							.replace(/ {2}/g, '&nbsp&nbsp');
						password.classList.remove('error');
						errorMessage.classList.add('hidden');
					} catch (e) {
						message.innerHTML = gibberish(encodedMessage.value);
						password.classList.add('error');
						errorMessage.classList.remove('hidden');
					}
				};
			};
		</script>
		<style>
			div {
				margin: 10px 0 10px 0;
			}
			textarea {
				font-family: monospace;
				width: 50em;
			}
			input {
				width: 20em;
			}
			p {
				font-family: monospace;
				min-height: 20em;
				border: 1px solid #ccc;
				border-radius: 7px;
			}
			span.error {
				color: red;
			}
			input.error {
				border: 2px solid red;
			}
			.hidden {
				display: none;
			}
		</style>
	</head>
	<body>

		<div style="display: flex; flex-direction: column;">
			<label
				for="encodedMessage">
				Copy/paste the encoded message from your email:
			</label>
			<textarea
				rows="20"
				id="encodedMessage"></textarea>
		</div>

		<div style="display: flex; flex-direction: column">
			<label
				for="password">
				Enter the password from your postcard:
			</label>
			<div style="display: flex; flex-direction: row">
				<input
					id="password"
					placeholder="Password"
					type="text">
				<span
					id="errorMessage"
					class="hidden error"
					style="margin-left: 10px">Incorrect password?</span>
			</div>
		</div>

		<div>
			<button
				id="decode"
				type="button">
				Decode Message
			</button>
		</div>

		<p id="message">
		</p>

	</body>
</html>